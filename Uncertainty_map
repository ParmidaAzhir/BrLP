import os
import numpy as np
import nibabel as nib

BASE_DIR = r"P:\MRI_PREDICTIONS"  

for subject in os.listdir(BASE_DIR):
    subject_path = os.path.join(BASE_DIR, subject)
    if not os.path.isdir(subject_path):
        continue

    pred_files = sorted([
        f for f in os.listdir(subject_path)
        if f.startswith("pred-mri-") and f.endswith(".nii.gz")
    ])

    if len(pred_files) != 64:
        print(f" Skipping {subject} (only {len(pred_files)} prediction files)")
        continue

    print(f"Processing {subject}")

    predictions = []
    for f in pred_files:
        img = nib.load(os.path.join(subject_path, f))
        predictions.append(img.get_fdata())


    variance_map = np.var(predictions, axis=0)




    ref_img = nib.load(os.path.join(subject_path, pred_files[0]))
    var_img = nib.Nifti1Image(variance_map, affine=ref_img.affine, header=ref_img.header)
    nib.save(var_img, os.path.join(subject_path, "uncertainty_map.nii.gz"))

print(" All uncertainty maps saved")
